# **スケーラブル設定画面アーキテクチャ設計書**

Version: 1.13 (Phase 1 Finalized \- Detailed Roadmap)

Date: 2025-12-18

Author: Lead Engineer / PM Partner

## **1\. 本ドキュメントの位置づけ**

本ドキュメントは、現在開発中の「社内AIチャットボット（Reactカスタムフロントエンド）」に対し、**拡張性と保守性に優れた設定画面機能を追加実装するための設計書**である。

既存のアプリケーションアーキテクチャを前提とし、追加される「設定画面（SettingsArea）」および関連する「開発者機能」の仕様のみを定義する。

## **2\. 設計方針 (Design Principles)**

### **2.1 Core Principles**

1. **Integrated Experience (2-Pane Layout):**  
   * モーダルウィンドウではなく、\*\*メインエリア（ChatArea）を置換する「2ペイン構成の設定画面」\*\*を採用し、没入感を損なわないUIとする。  
2. **Invisible RBAC (Role-Based Access Control):**  
   * ユーザーの役割（User/Admin/Developer）に応じて、設定カテゴリ自体をDOMレベルで非表示にする。権限のない設定項目はユーザーの目に触れない。  
3. **Developer Experience First:**  
   * 開発およびデバッグ効率を最大化するため、設定画面内だけでなく、**常駐ヘッダーからも開発モード（Mock/Real）の切り替えが可能**な設計とする。

## **3\. 役割定義 (Role Definitions)**

設定画面におけるペルソナとアクセス権限の定義。

| Role | 名称 | アクセス可能な設定範囲 |
| :---- | :---- | :---- |
| **User** | 一般社員 | ・プロフィール（表示名、アバター） ・表示設定（テーマ、フォントサイズ） ・**プロンプトテンプレート確認（Mock）** |
| **Admin** | 管理者 | ・Userの全権限 ・**RAGデータ管理（モック）** ・利用統計 |
| **Developer** | 開発者 | ・Adminの全権限 ・**API接続設定（ApiConfigModal呼び出し）** ・**開発モード設定（Real/BE/FE切り替え）** ・**User ID管理（変更・再生成）** ・**ペルソナ切り替え** |

## **4\. UIアーキテクチャ (UI Architecture)**

### **4.1 レイアウト構成**

ヘッダーは共通コンポーネントとして維持し、メインエリアをView Stateによって切り替える。

graph TD  
    AppContainer \--\> Sidebar\["Sidebar (Navigation)"\]  
    AppContainer \--\> MainColumn\["Main Column"\]  
      
    MainColumn \--\> Header\["Header (Always Visible)"\]  
    Header \--\> MockMode\["MockMode Select (Dev Only)"\]  
    Header \--\> PageTitle\["Page Title"\]  
      
    MainColumn \--\> ContentSwitch{View State}  
    ContentSwitch \-- "view \=== 'chat'" \--\> ChatArea  
    ContentSwitch \-- "view \=== 'settings'" \--\> SettingsArea

* **Header:**  
  * 開発者向けツール（MockModeSelect）を常駐させる。ここの操作は設定画面内の状態と同期する。  
* **SettingsArea:**  
  * **Left Pane (SettingsNav):** カテゴリ一覧リスト。  
  * **Right Pane (SettingsPanel):** 選択されたカテゴリの詳細コンポーネントを表示。

## **5\. コンポーネント構成と拡張性**

### **5.1 コンフィグ駆動型設計 (Configuration-Driven Design)**

設定項目の増減や順序変更に柔軟に対応するため、UIロジックと設定定義を完全に分離する。

* **定義の外部化 (Single Source of Truth):**  
  * 設定メニューの構造は settingsConfig.js という単一の静的ファイルで管理する。  
  * **重要:** コンポーネントは文字列ではなく、**インポートしたコンポーネントオブジェクト**として定義する（Reactでの動的レンダリングのため）。

// config/settingsConfig.js  
import { User, Settings, FileText, Terminal, MessageSquare } from 'lucide-react';  
import ProfileSettings from '../components/Settings/sections/ProfileSettings';  
import GeneralSettings from '../components/Settings/sections/GeneralSettings';  
import PromptSettings from '../components/Settings/sections/PromptSettings';  
import RAGSettings from '../components/Settings/sections/RAGSettings';  
import DebugSettings from '../components/Settings/sections/DebugSettings';

export const settingsCategories \= \[  
  {  
    id: 'profile',  
    label: 'プロフィール',  
    icon: User,  
    component: ProfileSettings,  
    allowedRoles: \['user', 'admin', 'developer'\],  
  },  
  {  
    id: 'general',  
    label: '一般設定',  
    icon: Settings,  
    component: GeneralSettings,  
    allowedRoles: \['user', 'admin', 'developer'\],  
  },  
  {  
    id: 'prompt',  
    label: 'プロンプト管理',  
    icon: MessageSquare,  
    component: PromptSettings,  
    allowedRoles: \['user', 'admin', 'developer'\], // All Roles  
  },  
  {  
    id: 'rag',  
    label: 'RAGデータ管理',  
    icon: FileText,  
    component: RAGSettings,  
    allowedRoles: \['admin', 'developer'\],  
  },  
  {  
    id: 'debug',  
    label: '開発者オプション',  
    icon: Terminal,  
    component: DebugSettings,  
    allowedRoles: \['developer'\],   
  },  
\];

* **汎用レンダリングエンジン:**  
  * SettingsNav および SettingsPanel は、この配列を読み込み、現在の currentUser.role に基づいてフィルタリングとレンダリングを行う。

### **5.2 ApiConfigModal の再利用**

既存の ApiConfigModal は、DebugSettings コンポーネントの一部として統合するのではなく、**Appルートレベル**で管理し、呼び出しトリガーのみを設定画面に配置する。

1. **配置:** App.jsx に \<ApiConfigModal isOpen={...} /\> を配置。  
2. **トリガー:** DebugSettings 内に「API設定を開く」ボタンを配置。  
3. **連携:** ボタンクリックイベントを介して App.jsx のステートを操作し、モーダルを開く。

## **6\. データ構造と状態管理**

### **6.1 データストア設計**

設定値はスキーマレスなJSONとしてLocalStorageに保存し、Phase 1におけるマイグレーションコストを排除する。

| 設定種別 | 保存場所 (Key) | スコープ・同期仕様 |
| :---- | :---- | :---- |
| **User Config** | app\_preferences\_{userId} | **アカウント個別** ログイン中の userId に紐付く。 |
| **System Config** | app\_system\_global | **端末内共有** 全Admin/Devユーザーで共有される設定（APIキー等）。 |

### **6.2 State & Persona Management**

ユーザー識別とペルソナ管理の戦略。SSO未導入のPhase 1では、ブラウザ生成のランダムIDを利用して擬似的な個人識別を行う。

* **ID生成戦略 (Random ID Strategy):**  
  * アプリ初回起動時に app\_user\_id がLocalStorageになければ、crypto.randomUUID() で生成して保存する。  
  * これにより、異なるブラウザ/ユーザー間での設定や履歴の混線を防ぐ。

// App.jsx (Initialization Logic Concept)  
useEffect(() \=\> {  
  // 1\. User IDの取得または生成  
  let storedUserId \= localStorage.getItem('app\_user\_id');  
  if (\!storedUserId) {  
    storedUserId \= \`user-${crypto.randomUUID().slice(0, 8)}\`;  
    localStorage.setItem('app\_user\_id', storedUserId);  
  }

  // 2\. Stateの初期化  
  setCurrentUser(prev \=\> ({  
    ...prev,  
    id: storedUserId,  
    role: 'developer', // Default role for Phase 1 dev  
    // ...  
  }));  
}, \[\]);

## **7\. 開発者機能とエミュレーションアーキテクチャ**

開発効率向上とAPIコスト削減のため、以下の3段階の動作モードを定義し、厳密に制御する。

### **7.1 動作モード定義**

| モード | 名称 | API通信 | 役割・挙動 |
| :---- | :---- | :---- | :---- |
| **Real Mode** | 本番通信 | **あり** | 実際のDify APIと通信し、生成AIによる応答を行う。 |
| **BE Mode** | バックエンドモック | **あり** | Dify APIへ isDebugMode: true を送信。Dify側での固定応答テスト用。 |
| **FE Mode** | フロントエンドモック | **なし** | **完全オフライン**。ブラウザ内のJS (MockStreamGenerator) でストリーム応答を生成。 |

### **7.2 ChatService Adapter Pattern**

UI層（Hooks）と通信層の間にAdapterを介在させ、モードに応じて接続先を切り替える。

graph LR  
    UI\[ChatArea / useChat\] \--\> Adapter\[ChatService Adapter\]  
      
    Adapter \-- "Real / BE Mode" \--\> ApiClient\[Dify API Client\]  
    Adapter \-- "FE Mode" \--\> MockGen\[Mock Stream Generator\]  
      
    ApiClient \-- "HTTP Request" \--\> DifyCloud\[Dify Cloud API\]  
    MockGen \-- "Async Loop" \--\> LocalData\[Local Scenarios (JS)\]

### **7.3 整合性の確保**

* **モード切替の同期:** Headerにある MockModeSelect と、設定画面内の DebugSettings にあるモード選択プルダウンは、**同一のState（mockMode）を参照・更新**する。どちらを変更しても、即座にもう一方へ反映される。

### **7.4 User ID管理機能 (User ID Editor)**

SSO環境のシミュレーションや、特定のユーザー設定での再現テストを行うため、DebugSettings 内にID操作機能を実装する。

* **機能仕様:**  
  1. **現在IDの表示:** 現在の currentUser.id を表示し、ワンクリックでコピー可能にする。  
  2. **ID変更 (Edit):** テキスト入力により任意のID文字列（例: test-user-001）へ変更可能にする。  
  3. **再生成 (Regenerate):** ランダムなUUIDを新規発行し、実質的な「新規ユーザー」としての挙動を確認する。  
* **変更時の挙動:**  
  * LocalStorageの app\_user\_id を更新し、アプリをリロード（またはStateの完全リセット）して、新しいIDに紐付く設定 (app\_preferences\_{newId}) を読み込ませる。

## **8\. Phase 1 実装ロードマップ (Detailed Implementation Plan)**

以下のステップ順に実装を行い、各段階で動作確認を行う。

### **Step 1: 設定画面基盤の構築 (Foundation)**

* **目的:** チャット画面と設定画面の切り替え基盤を確立する。  
* **作業内容:**  
  1. **コンフィグ作成:** src/config/settingsConfig.js を作成し、カテゴリ定義とコンポーネントマップを記述する（アイコン含む）。  
  2. **コンポーネント作成:** src/components/Settings/ ディレクトリ配下に SettingsArea.jsx, SettingsNav.jsx, SettingsPanel.jsx を実装する。  
  3. **App.jsx改修:** currentView ステート ('chat' | 'settings') を追加し、条件付きレンダリングを実装する。サイドバー設定ボタン等で setView('settings') を発火させる。  
  4. **デザイン適用:** DESIGN\_RULE.md に基づき、2ペインレイアウトのレスポンシブ対応を行う。

### **Step 2: ID管理と状態初期化 (Identity & Persistence)**

* **目的:** ユーザーごとの設定保持とSSOエミュレーション基盤を作る。  
* **作業内容:**  
  1. **ID生成ロジック:** App.jsx 初期化時に localStorage をチェックし、User IDがない場合はUUIDを生成・保存するロジックを実装。  
  2. **Hooks実装:** useSettings カスタムフックを作成。app\_preferences\_{userId} の読み書きを行う。  
  3. **State結合:** currentUser ステートに id と role を持たせ、アプリ全体で共有する。

### **Step 3: 開発者機能の実装 (Developer Tools)**

* **目的:** API設定とデバッグ環境を整える。  
* **作業内容:**  
  1. **DebugSettings実装:** src/components/Settings/sections/DebugSettings.jsx を作成。  
  2. **APIモーダル連携:** App.jsx にある ApiConfigModal の開閉関数を DebugSettings から呼び出せるようにする。  
  3. **User ID Editor:** IDの表示・編集・再生成ボタンを実装し、ID変更時にリロードする処理を追加する。  
  4. **モード同期:** ヘッダーの MockModeSelect と DebugSettings 内のプルダウンを同期させる。

### **Step 4: 通信層のアダプター実装 (Service Adapter)**

* **目的:** 完全オフラインでの動作 (FE Mode) を実現する。  
* **作業内容:**  
  1. **useChat改修:** sendMessage 関数内に分岐ロジック（Adapter）を追加。mockMode \=== 'FE' の場合、APIリクエストを行わず src/mocks/MockStreamGenerator.js を呼び出す。  
  2. **APIテスト挙動の分岐:** ApiConfigModal (または関連フック) 内の接続テストロジックにおいて、FEモード時は通信を行わずに「成功 (Mock Connected)」を返すよう改修する。

### **Step 5: コンテンツコンポーネントの実装 (Content Sections)**

* **目的:** 各設定画面の中身を実装する。  
* **作業内容:**  
  1. **ProfileSettings:** 表示名、アバター設定フォームを作成し、useSettings で保存する。  
  2. **GeneralSettings:** テーマ（ダーク/ライト）、フォントサイズ設定を作成。  
  3. **PromptSettings:** システムプロンプトの読み取り専用表示（モックテキスト）を実装。  
  4. **RAGSettings:** ファイル一覧のダミーテーブル表示（追加ボタン等のUI配置確認）を実装。

## **9\. プロジェクトスコープ定義 (Phase 1 vs Phase 2+)**

本アーキテクチャにおける実装範囲の境界線。Phase 1は「スケーラビリティの基盤構築」と「PoCとしての動作」に集中する。

### **9.1 Phase 1 Scope (Current Target)**

* **認証・ID管理:**  
  * **\[更新\] SSOエミュレーション:** ブラウザごとにランダムなUser IDを生成・保持し、擬似的に個別のユーザーとして振る舞う。  
  * 仮想的なペルソナ（User/Admin/Developer）を手動で切り替える機能（Mock Identity）。  
* **データ永続化:**  
  * **User Config:** LocalStorageを用いたブラウザごとの永続化。  
  * **System Config:** .env 初期値 ＋ LocalStorage ＋ 手動JSONエクスポート/インポートによる同期。  
* **設定画面機能:**  
  * **Profile/General:** 基本的な入力フォームとUI反映。  
  * **Prompt Management:** 全ユーザーが閲覧可能なシステムプロンプト確認画面（Mock）。  
  * **RAG Console:** アップロード済みドキュメント一覧とステータス確認画面（Mock）。  
  * **Debug Settings:** API設定、モード切替、ロール切替の完全実装。  
* **API通信:**  
  * 「FEモード（完全オフライン）」の実装と、Real/BEモードとの共存。

### **9.2 Phase 2+ Scope (Future Work)**

* **認証・ID管理:**  
  * Microsoft Entra ID (SSO) との完全連携。  
* **データ永続化:**  
  * Firestore/RDBを用いたクラウド同期。  
* **設定画面機能:**  
  * Dify APIを用いた実際の統計・ログ分析。  
  * 実際のファイルアップロードとベクターストア連携。

## **10\. Phase 1 設定項目一覧 (Configuration List)**

Phase 1の実装スコープに含まれる具体的な設定項目一覧。  
各項目は settingsConfig.js にて定義され、将来的な項目の増減や順序変更は、設定ファイルの修正のみで柔軟に対応可能である。

| カテゴリ | 項目名 | 対象 Role | 概要・備考 |
| :---- | :---- | :---- | :---- |
| **プロフィール** | 表示名 (Display Name) | All | アプリ内でのユーザー表示名。Entra IDの本名とは別に設定可能。 |
|  | アバター (Avatar) | All | アイコン画像のURL設定（Phase 1はテキストURL入力または簡易選択）。 |
| **一般設定** | テーマ (Theme) | All | ライト / ダーク / システム準拠 の切り替え。 |
|  | フォントサイズ | All | メッセージテキストの大きさ調整 (Small / Medium / Large)。 |
| **プロンプト管理** | プロンプト確認 | **All** | **\[Mock\]** システムプロンプト（AIの人格設定）のテンプレート確認画面。Phase 1では全ユーザーが閲覧可能。 |
| **RAG管理** | ナレッジベース管理 | Admin, Dev | **\[Mock\]** アップロード済みドキュメント一覧とステータス確認画面（UIのみ）。ファイル追加ボタン等のUI配置確認を行う。 |
| **管理コンソール** | 利用統計 (ダミー) | Admin, Dev | **\[Mock\]** トークン使用量やユーザーアクティビティのグラフ表示確認用。 |
| **開発者オプション** | API接続設定 | Dev | ApiConfigModal を呼び出し、Dify APIキーを設定・テストする。 |
|  | 動作モード (Mode) | Dev | **Real / BE / FE** の切り替え。ヘッダーのセレクタと同期する。 |
|  | ペルソナ切替 (Role) | Dev | **User / Admin / Developer** の権限を擬似的に切り替え、UI表示を確認する。 |
|  | 設定同期 (Sync) | Dev | システム設定(JSON)のエクスポート・インポート機能（手動同期用）。 |
|  | **User ID管理** | Dev | **\[追加\]** 現在のID表示・コピー。デバッグ用に任意のIDへ変更または再生成する機能。 |

*End of Document*
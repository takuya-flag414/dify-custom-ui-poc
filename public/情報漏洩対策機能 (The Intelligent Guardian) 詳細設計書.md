# **情報漏洩対策機能 (The Intelligent Guardian) 詳細設計書**

Version: 1.0.1 (Phase 1 Revised)  
Date: 2025-05-XX  
Author: Lead Engineer & PM Partner  
Related Doc: DESIGN\_SPEC\_SANITIZATION.md (双方向サニタイズ詳細 \- Phase 2実装予定)

## **1\. プロジェクト背景と目的**

エンタープライズ環境におけるAI導入の最大の障壁である「情報漏洩リスク」に対し、従来の「禁止・監視」型のアプローチではなく、**「気付き・自律」型**のモダンなUXでアプローチする。

本機能群の総称を **"The Intelligent Guardian"** と定義し、ユーザーが誤って機密情報（PII、社外秘情報など）を入力・アップロードしようとした際、サーバーにデータが送信される**前**にブラウザ内で検知し、直感的なフィードバックを与えることを目的とする。

### **1.1 Core Philosophy**

* **Water's Edge Strategy (水際対策):** データがユーザーのデバイスを離れる前に検知する。  
* **Nudge, Don't Block:** 思考を遮断するモーダル警告は廃止。視覚的な「違和感（Amber Glow）」で気付きを与える。  
* **Privacy First:** 検知ロジックは全てクライアントサイド（ブラウザ）で完結させる。

## **2\. 機能要件 (Functional Requirements)**

### **2.1 テキスト入力保護 (Real-time Privacy Masking)**

チャット入力時のうっかりミスを防ぐ機能。  
※詳細は別紙 DESIGN\_SPEC\_SANITIZATION.md を参照。

* **概要:** 入力テキストをリアルタイム監視し、機密情報を検知した瞬間に視覚的警告を行う。  
* **挙動:** 該当テキストが琥珀色（Amber）に発光し、入力欄に盾アイコンが出現する。  
* **送信時 (Phase 1):** 警告を表示したまま送信を許可する（ユーザーの判断に委ねる）。  
* **送信時 (Phase 2):** 自動的にセマンティックトークン（例: \[PHONE\_NUMBER\_1\]）へ置換して送信する。

### **2.2 ドキュメント保護 (Pre-flight Document Scan)**

本ドキュメントにおける主要定義範囲。  
ファイルをサーバー（Dify）へアップロードする直前に、ブラウザ内で中身を解析・検知する機能。

* **Trigger:** ファイルのドラッグ＆ドロップ、または選択時。  
* **Process:**  
  1. **Local Parsing:** ブラウザ内でテキスト抽出（PDF/Word等）。  
  2. **Regex Scanning:** 定義済みルールに基づきマッチング。  
  3. **Decision:** 機密情報が含まれる場合、アップロードを一時保留（Pending）し警告を表示。  
* **Action:**  
  * **Warning (Phase 1):** 「機密情報が含まれる可能性があります」と表示するが、ユーザーの意思で送信（Upload Anyway）は可能とする。

## **3\. 検知対象定義 (Detection Scope)**

誤検知（False Positive）によるUX低下を防ぐため、Phase 1では「パターンが明確かつリスクが高い情報」に限定する。  
人名・住所は文脈依存が強いため、原則として対象外とする。

| カテゴリ | 優先度 | 対象パターン概要 | 備考 |
| :---- | :---- | :---- | :---- |
| **金融情報** | **Critical** | クレジットカード番号 (Luhnチェック済) | 14-16桁 |
| **開発機密** | **Critical** | APIキー (sk-, AKIA, ghp\_ 等) | 誤送信時の被害甚大 |
| **個人特定** | High | 電話番号 (090等ハイフン必須) | インデックス付与対象 |
| **連絡先** | High | メールアドレス | インデックス付与対象 |
| **マイナンバー** | High | 12桁数字 \+ 周辺KW(個人番号等) | Lookbehindで精度向上 |
| **社外秘KW** | High | 社外秘, Confidential, 極秘, Do Not Distribute | 完全一致 |
| **郵便番号** | Medium | 〒\\d{3}-\\d{4} | 住所の代替検知として利用 |
| **人名・住所** | \- | **対象外 (Phase 1\)** | 誤検知防止のため |

## **4\. UI/UX仕様 (Interaction Design)**

DESIGN\_RULE\_V2.md に準拠し、ユーザーの不安を煽らず、かつ明確にリスクを伝える演出を行う。

### **4.1 ファイルスキャン演出 (Scanning State)**

* **Animation:**  
  * ファイルカードが表示された瞬間、カードの縁（Border）を光のラインが1周するアニメーション（所要時間: 0.5s〜1.0s）。  
  * この間、カードは半透明（Opacity 0.7）かつ操作不能となる。  
  * *意図:* 「ちゃんとチェックしていますよ」という信頼感の醸成。

### **4.2 警告表示 (Warning State)**

* **Visual:**  
  * 検知された場合、ファイルカード全体が **Amber Glow (effect-glow-warning)** を帯びる。  
  * 背景色が薄い琥珀色 (bg-amber-500/10) に変化。  
* **Message:**  
  * カード下部に「⚠️ 機密情報が含まれている可能性があります」と表示。  
  * 詳細ボタン（Popover）で、どのカテゴリ（例: "クレジットカード番号"）が検知されたかを表示（具体的な値は表示しない）。  
* **Action:**  
  * 削除: ファイルを取り消す。  
  * そのまま送信: リスクを承諾してアップロードを実行する。

## **5\. 技術アーキテクチャ (Technical Architecture)**

### **5.1 クライアントサイド・パーサー**

サーバー負荷ゼロかつセキュリティ担保のため、全てWeb AssemblyまたはJSライブラリで完結させる。

| ファイル形式 | 使用ライブラリ | 備考 |
| :---- | :---- | :---- |
| **PDF** (.pdf) | pdfjs-dist | テキストレイヤーのみ抽出。画像化された文字は対象外。 |
| **Word** (.docx) | mammoth.js | Raw Text抽出に特化して使用。 |
| **Excel** (.xlsx) | xlsx (SheetJS) | 全セルの値を文字列結合してスキャン。 |
| **Text** (.txt, .md, .json) | Native JS | FileReader APIを使用。 |
| **Image** (.png, .jpg) | \- | **Phase 1では対象外**（OCRはブラウザ負荷が高いため）。 |

### **5.2 パフォーマンス要件**

* **Web Worker:** ファイル解析とRegexマッチングは、メインスレッドをブロックしないよう **Web Worker** 内で実行する。  
* **Timeout:** 解析に5秒以上かかる巨大ファイルは、「解析タイムアウト（未スキャン）」として扱い、ログを残しつつアップロードを許可する（UX優先）。

## **6\. 開発ロードマップ**

### **Phase 1: Awareness (今回の実装範囲)**

* **目的:** ユーザーのリテラシー向上と、うっかりミスの防止。  
* **機能:**  
  * テキスト入力時のリアルタイム検知と警告表示（Amber Glow）。  
  * ファイルアップロード時の事前スキャンと警告表示。  
  * アクションは\*\*「警告のみ」\*\*とし、送信の判断はユーザーに委ねる。

### **Phase 2: Prevention & Admin (将来構想)**

* **目的:** コンプライアンスの強制適用と自動保護。  
* **機能:**  
  * **Auto-Sanitization:** 送信時に機密情報をセマンティックトークンへ自動置換する機能。  
  * **Blocking:** 特定の「Critical」カテゴリ（APIキー等）が含まれる場合、送信ボタンをDisabledにする。  
  * **OCR:** WASM版 Tesseract.js を導入し、スクリーンショット内の機密情報も検知。  
  * **Audit Log:** 警告を無視して送信された履歴を（内容は伏せて）管理者へレポートする。